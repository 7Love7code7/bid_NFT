<html>
  <script src="web3.min.js"></script>
  <script>
    // Core JS

    const ERC20JSON = [{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"owner","type":"address"},{"indexed":true,"internalType":"address","name":"spender","type":"address"},{"indexed":false,"internalType":"uint256","name":"value","type":"uint256"}],"name":"Approval","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"from","type":"address"},{"indexed":true,"internalType":"address","name":"to","type":"address"},{"indexed":false,"internalType":"uint256","name":"value","type":"uint256"}],"name":"Transfer","type":"event"},{"inputs":[],"name":"name","outputs":[{"internalType":"string","name":"","type":"string"}],"stateMutability":"view","type":"function","constant":true},{"inputs":[],"name":"symbol","outputs":[{"internalType":"string","name":"","type":"string"}],"stateMutability":"view","type":"function","constant":true},{"inputs":[],"name":"decimals","outputs":[{"internalType":"uint8","name":"","type":"uint8"}],"stateMutability":"view","type":"function","constant":true},{"inputs":[],"name":"totalSupply","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function","constant":true},{"inputs":[{"internalType":"address","name":"account","type":"address"}],"name":"balanceOf","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function","constant":true},{"inputs":[{"internalType":"address","name":"recipient","type":"address"},{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"transfer","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"owner","type":"address"},{"internalType":"address","name":"spender","type":"address"}],"name":"allowance","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function","constant":true},{"inputs":[{"internalType":"address","name":"spender","type":"address"},{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"approve","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"sender","type":"address"},{"internalType":"address","name":"recipient","type":"address"},{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"transferFrom","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"spender","type":"address"},{"internalType":"uint256","name":"addedValue","type":"uint256"}],"name":"increaseAllowance","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"spender","type":"address"},{"internalType":"uint256","name":"subtractedValue","type":"uint256"}],"name":"decreaseAllowance","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"nonpayable","type":"function"}];

    const ERC721JSON = [{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"owner","type":"address"},{"indexed":true,"internalType":"address","name":"approved","type":"address"},{"indexed":true,"internalType":"uint256","name":"tokenId","type":"uint256"}],"name":"Approval","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"owner","type":"address"},{"indexed":true,"internalType":"address","name":"operator","type":"address"},{"indexed":false,"internalType":"bool","name":"approved","type":"bool"}],"name":"ApprovalForAll","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"from","type":"address"},{"indexed":true,"internalType":"address","name":"to","type":"address"},{"indexed":true,"internalType":"uint256","name":"tokenId","type":"uint256"}],"name":"Transfer","type":"event"},{"inputs":[{"internalType":"bytes4","name":"interfaceId","type":"bytes4"}],"name":"supportsInterface","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"owner","type":"address"}],"name":"balanceOf","outputs":[{"internalType":"uint256","name":"balance","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"tokenId","type":"uint256"}],"name":"ownerOf","outputs":[{"internalType":"address","name":"owner","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"from","type":"address"},{"internalType":"address","name":"to","type":"address"},{"internalType":"uint256","name":"tokenId","type":"uint256"}],"name":"transferFrom","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"to","type":"address"},{"internalType":"uint256","name":"tokenId","type":"uint256"}],"name":"approve","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"tokenId","type":"uint256"}],"name":"getApproved","outputs":[{"internalType":"address","name":"operator","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"operator","type":"address"},{"internalType":"bool","name":"_approved","type":"bool"}],"name":"setApprovalForAll","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"owner","type":"address"},{"internalType":"address","name":"operator","type":"address"}],"name":"isApprovedForAll","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"from","type":"address"},{"internalType":"address","name":"to","type":"address"},{"internalType":"uint256","name":"tokenId","type":"uint256"}],"name":"safeTransferFrom","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"from","type":"address"},{"internalType":"address","name":"to","type":"address"},{"internalType":"uint256","name":"tokenId","type":"uint256"},{"internalType":"bytes","name":"data","type":"bytes"}],"name":"safeTransferFrom","outputs":[],"stateMutability":"nonpayable","type":"function"}];

    const MyNFTJSON = [{"inputs":[],"stateMutability":"nonpayable","type":"constructor"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint64","name":"id","type":"uint64"},{"indexed":false,"internalType":"uint256","name":"time","type":"uint256"}],"name":"AuctionExtended","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint64","name":"id","type":"uint64"},{"indexed":true,"internalType":"address","name":"nftRecipient","type":"address"},{"indexed":false,"internalType":"uint256","name":"price","type":"uint256"}],"name":"AuctionFinished","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint64","name":"id","type":"uint64"},{"indexed":true,"internalType":"address","name":"bidder","type":"address"},{"indexed":false,"internalType":"uint256","name":"price","type":"uint256"}],"name":"Bid","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint64","name":"id","type":"uint64"},{"indexed":true,"internalType":"address","name":"creator","type":"address"},{"indexed":false,"internalType":"address","name":"currency","type":"address"},{"indexed":true,"internalType":"address","name":"platform","type":"address"},{"indexed":false,"internalType":"uint256","name":"token","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"price","type":"uint256"},{"indexed":false,"internalType":"uint8","name":"timeInDays","type":"uint8"},{"indexed":false,"internalType":"address","name":"referrer","type":"address"}],"name":"ListingCreated","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"previousOwner","type":"address"},{"indexed":true,"internalType":"address","name":"newOwner","type":"address"}],"name":"OwnershipTransferred","type":"event"},{"stateMutability":"payable","type":"fallback"},{"inputs":[],"name":"owner","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"renounceOwnership","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"newOwner","type":"address"}],"name":"transferOwnership","outputs":[],"stateMutability":"nonpayable","type":"function"},{"stateMutability":"payable","type":"receive"},{"inputs":[{"internalType":"bytes4","name":"interfaceId","type":"bytes4"}],"name":"supportsInterface","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"pure","type":"function"},{"inputs":[{"internalType":"address","name":"operator","type":"address"},{"internalType":"address","name":"","type":"address"},{"internalType":"uint256","name":"tokenId","type":"uint256"},{"internalType":"bytes","name":"","type":"bytes"}],"name":"onERC721Received","outputs":[{"internalType":"bytes4","name":"","type":"bytes4"}],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"currency","type":"address"}],"name":"getPriceUnit","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"account","type":"address"}],"name":"balanceOf","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"account","type":"address"}],"name":"withdraw","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"id","type":"uint256"}],"name":"getListing","outputs":[{"components":[{"internalType":"address","name":"creator","type":"address"},{"internalType":"address","name":"currency","type":"address"},{"internalType":"contract IERC721","name":"platform","type":"address"},{"internalType":"uint256","name":"token","type":"uint256"},{"internalType":"uint256","name":"price","type":"uint256"},{"internalType":"address","name":"referrer","type":"address"},{"internalType":"bool","name":"allowMarketplace","type":"bool"},{"internalType":"address","name":"marketplace","type":"address"},{"internalType":"address","name":"highBidder","type":"address"},{"internalType":"uint256","name":"endTime","type":"uint256"},{"internalType":"bool","name":"paidOut","type":"bool"}],"internalType":"struct MyNFT.Listing","name":"","type":"tuple"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"currency","type":"address"},{"internalType":"contract IERC721","name":"platform","type":"address"},{"internalType":"uint256","name":"token","type":"uint256"},{"internalType":"uint256","name":"price","type":"uint256"},{"internalType":"uint8","name":"timeInDays","type":"uint8"},{"internalType":"address","name":"referrer","type":"address"},{"internalType":"bool","name":"allowMarketplace","type":"bool"}],"name":"list","outputs":[{"internalType":"uint64","name":"","type":"uint64"}],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint64","name":"id","type":"uint64"}],"name":"getNextBid","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint64","name":"id","type":"uint64"},{"internalType":"address","name":"marketplace","type":"address"}],"name":"bid","outputs":[],"stateMutability":"payable","type":"function"},{"inputs":[{"internalType":"uint64","name":"id","type":"uint64"}],"name":"finish","outputs":[],"stateMutability":"nonpayable","type":"function"}];

    const MyNFTAddress = "0xe13eC2aB504B6D55a60A080B2486C165880A135D";

    let MyNFT;
    let from;

    window.onload = async () => {
      if (window.ethereum) {
        window.web3 = new Web3(window.ethereum);
        from = (await ethereum.request({ method: "eth_requestAccounts" }))[0];
        MyNFT = new web3.eth.Contract(MyNFTJSON, MyNFTAddress);
      } else {
        alert("Metamask is required");
      }
    }

    // Convert to a usable value
    function atomic(value, decimals) {
      let quantity = decimals;
      if (value.indexOf(".") !== -1) {
        quantity -= value.length - value.indexOf(".") - 1;
      }
      let atomicized = value.replace(".", "");
      for (let i = 0; i < quantity; i++) {
        atomicized += "0";
      }
      while (atomicized[0] === "0") {
        atomicized = atomicized.substr(1);
      }
      return atomicized;
    }

    // Convert to a human readable value
    function unatomic(value, decimals) {
      value = value.padStart(decimals + 1, "0");
      let temp = (
        value.substr(0, value.length - decimals) +
        "." +
        value.substr(value.length - decimals)
      );
      while (temp[0] === "0") {
        temp = temp.substr(1);
      }
      while (temp.endsWith("0")) {
        temp = temp.slice(0, -1);
      }
      if (temp.endsWith(".")) {
        temp = temp.slice(0, -1);
      }
      if (temp.startsWith(".")) {
        temp = "0" + temp;
      }
      if (temp == "") {
        return "0";
      }
      return temp;
    }

    // When currency is null, it's ETH

    // Get the decimals of an ERC20
    async function getDecimals(currency) {
      if (!currency) {
        return 18;
      }
      return await (new web3.eth.Contract(ERC20JSON, currency)).methods.decimals().call();
    }

    // Get how many decimals MyNFT uses with an ERC20
    async function getDecimalAccuracy(currency) {
      return Math.min(await getDecimals(currency), 4);
    }

    // Get the 'price unit' of an ERC20
    // An ERC20 which MyNFT uses 4 decimals of has a price unit of 0.0001
    // Every price value will be a multiple of this
    async function getPriceUnit(currency) {
      let decimals = await getDecimals(currency);
      if (!currency) {
        currency = "0x0000000000000000000000000000000000000000";
      }
      return unatomic(await MyNFT.methods.getPriceUnit(currency).call(), decimals);
    }

    // Get the minimum price MyNFT will use in relation to an ERC20
    async function getMinimumPrice(currency) {
      let decimals = await getDecimals(currency);
      if (!currency) {
        currency = "0x0000000000000000000000000000000000000000";
      }
      return unatomic(
        (new web3.utils.BN(await MyNFT.methods.getPriceUnit(currency).call()))
          .mul(new web3.utils.BN(20)).toString(),
        decimals
      );
    }

    // Get all NFTs for the current user as a list of [platform, token]
    // Only works for accounts who have received <1000 NFTs (including repeats)
    // Chunk the getPastLogs call or limit to a specific NFT platform to avoid this
    async function getNFTs() {
      // Get all transfers to us
      let logs = await web3.eth.getPastLogs({
        fromBlock: 0,
        toBlock: "latest",
        topics: [
          "0xddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef",
          null,
          "0x" + from.split("0x")[1].padStart(64, "0")
        ]
      });

      // Filter to just tokens which are still in our custody
      let res = [];
      var ids = {};
      for (let log of logs) {
        let address = log.address;
        let id = log.topics[3];
        let owner = await (new web3.eth.Contract(ERC721JSON, address)).methods.ownerOf(id).call();
        if (owner.toLowerCase() != from.toLowerCase()) {
          continue
        }

        let jointID = address + id;
        if (ids[jointID]) {
          continue;
        }
        ids[jointID] = true;
        res.push([address, id]);
      }
      return res;
    }

    // List an ERC71. Returns the auction ID
    // string, string, string, string, 0 < int <= 30
    async function list(currency, platform, token, price, days, allowMarketplace) {
      let decimals = await getDecimals(currency);
      if (!currency) {
        currency = "0x0000000000000000000000000000000000000000";
      }

      await (new web3.eth.Contract(ERC721JSON, platform)).methods.approve(MyNFTAddress, token).send({ from });
      return (await MyNFT.methods.list(
        currency, platform, token, atomic(price, decimals), days,
        "0x0000000000000000000000000000000000000000", allowMarketplace
      ).send({ from })).events.ListingCreated.returnValues[0];
    }

    async function getListing(id) {
      function nullIfZeroAddress(value) {
        if (value === "0x0000000000000000000000000000000000000000") {
          return null;
        }
        return value;
      }

      let raw = await MyNFT.methods.getListing(id).call();
      let currency = nullIfZeroAddress(raw.currency);

      let highBidder = nullIfZeroAddress(raw.highBidder);
      let currentBid = raw.price;
      let nextBid = await MyNFT.methods.getNextBid(id).call();
      let decimals = await getDecimals(currency);
      if (currentBid === nextBid) {
        currentBid = null;
      } else {
        currentBid = unatomic(currentBid, decimals);
      }

      let referrer = nullIfZeroAddress(raw.referrer);
      let marketplace = nullIfZeroAddress(raw.marketplace);

      let bids = [];
      for (let bid of await web3.eth.getPastLogs({
        fromBlock: 0,
        toBlock: "latest",
        address: MyNFTAddress,
        topics: [
          "0xdbf5dea084c6b3ed344cc0976b2643f2c9a3400350e04162ea3f7302c16ee914",
          "0x" + (new web3.utils.BN(id)).toString("hex").padStart(64, "0")
        ]
      })) {
        bids.push({
          bidder: "0x" + bid.topics[2].substr(-40),
          price: unatomic((new web3.utils.BN(bid.data.substr(2), "hex")).toString(), decimals)
        });
      }

      return {
        id,
        creator: raw.creator,
        currency,
        platform: raw.platform,
        token: raw.token,

        highBidder,
        currentBid,
        nextBid: unatomic(nextBid, decimals),

        referrer,
        allowMarketplace: raw.allowMarketplace,
        marketplace,

        endTime: raw.endTime,
        paidOut: raw.paidOut,

        bids
      };
    }

    async function bid(id) {
      let currency = (await getListing(id)).currency;
      if (currency) {
        await (
          new web3.eth.Contract(ERC20JSON, currency)
        ).methods.approve(MyNFTAddress, await MyNFT.methods.getNextBid(id).call()).send({ from });
        await MyNFT.methods.bid(id, "0x0000000000000000000000000000000000000000").send({ from });
      } else {
        await MyNFT.methods.bid(id, "0x0000000000000000000000000000000000000000").send({ from, value: await MyNFT.methods.getNextBid(id).call() });
      }
    }

    async function getListings(creator, platform) {
      let creatorTopic = null;
      if (creator) {
        creatorTopic = "0x" + creator.substr(2).toLowerCase().padStart(64, "0");
      }

      let platformTopic = null;
      if (platform) {
        platformTopic = "0x" + platform.substr(2).toLowerCase().padStart(64, "0");
      }

      let res = [];
      for (let listing of await web3.eth.getPastLogs({
        fromBlock: 0,
        toBlock: "latest",
        address: MyNFTAddress,
        topics: [
          "0xb8160cd5a5d5f01ed9352faa7324b9df403f9c15c1ed9ba8cb8ee8ddbd50b748",
          null,
          creatorTopic,
          platformTopic
        ]
      })) {
        res.push((new web3.utils.BN(listing.topics[1].substr(2), "hex")).toString());
      }
      return res;
    }

    async function finish(id) {
      await MyNFT.methods.finish(id).send({ from });
    }

    async function getETHBalance() {
      return unatomic((await MyNFT.methods.balanceOf(from).call()) || "0", 18);
    }

    async function withdraw() {
      await MyNFT.methods.withdraw(from).send({ from });
    }
  </script>

  <script>
    async function getListingsHTML() {
      let list = await getListings();
      for (let i in list) {
        list[i] = await getListing(i);
      }
      document.getElementById("listList").innerHTML = JSON.stringify(list, null, 4);
    }

    async function update() {
      document.getElementById("nftList").innerHTML = JSON.stringify(await getNFTs(), null, 4);
      getListingsHTML();
      document.getElementById("balance").innerHTML = await getETHBalance();
    }

    setInterval(update, 5000);
    setTimeout(update, 1000);

    async function listButton() {
      await list(
        null,
        document.getElementById("address").value,
        document.getElementById("token").value,
        document.getElementById("amount").value,
        parseInt(document.getElementById("days").value),
        false
      );
    }

    async function bidButton() {
      await bid(parseInt(document.getElementById("listing").value));
    }

    async function finishButton() {
      await finish(parseInt(document.getElementById("listing").value));
    }
  </script>

  NFTs: <div id="nftList"></div>
  <hr><br>

  List:
  <br>
  Contract: <input id="address"></input>
  ID: <input id="token"></input>
  Amount: <input id="amount"></input>
  Days: <input id="days"></input>
  <button onclick="listButton()">List</button>
  <hr><br>

  Listings:
  <div id="listList"></div>
  <hr><br>

  Interact with existing listing:
  <br>
  Listing: <input id="listing"></input>
  <br>
  <button onclick="bidButton()">Bid</button>
  <br>
  <button onclick="finishButton()">Finish</button>
  <hr><br>

  ETH in contract: <div id="balance"></div>
  <button onclick="withdraw()">Withdraw</button>

</html>
